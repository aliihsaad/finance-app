<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ali's Personal Finance</title>
    <meta name="description" content="Personal Finance Dashboard">
    <meta name="theme-color" content="#667eea">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Personal Finance">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Personal Finance">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <link rel="apple-touch-icon" sizes="512x512" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBlcnNvbmFsIEZpbmFuY2UgRGFzaGJvYXJkIiwKICAic2hvcnRfbmFtZSI6ICJGaW5hbmNlIiwKICAiZGVzY3JpcHRpb24iOiAiQUktUG93ZXJlZCBQZXJzb25hbCBGaW5hbmNlIE1hbmFnZW1lbnQiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzY2N2VlYSIsCiAgInRoZW1lX2NvbG9yIjogIiM2NjdlZWEiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQUVBQUFBQkNBWUFBQUFmRmNTSkFBQUFEVWxFUVZSNDJtTmsrTTlRRHdBRGhnR0FXalI5YXdBQUFBQkpSVTVFcmtKZ2dnPT0iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FZQUFBQWZGY1NKQUFBQURVY0VRVlI0Mm1OaytNOVFEd0FEaGdHQVdqUjlhd0FBQUFCSlJVNUVya0pnZ2c9PSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0sCiAgImNhdGVnb3JpZXMiOiBbImZpbmFuY2UiLCAicHJvZHVjdGl2aXR5Il0sCiAgImxhbmciOiAiZW4iCn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tab-content.active {
            display: block;
            opacity: 1;
        }

        /* Connection Status */
        .connection-status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 600;
            background: rgba(13, 110, 253, 0.2);
            color: #0d6efd;
            border: 2px solid #0d6efd;
        }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Balance Card */
        .balance-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Forms */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* List Items */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .list-amount {
            font-weight: 600;
            color: #667eea;
            text-align: right;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            animation: slideIn 0.3s ease;
        }

        .success {
            background: rgba(25, 135, 84, 0.1);
            color: #198754;
        }

        .error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .info {
            background: rgba(13, 110, 253, 0.1);
            color: #0d6efd;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .nav-tab {
                flex-shrink: 0;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .balance-amount {
                font-size: 2rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üí∞ Personal Finance Dashboard</h1>
        <p>AI-Powered Financial Management</p>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('dashboard', this)">üìä Dashboard</button>
        <button class="nav-tab" onclick="showTab('transactions', this)">üí≥ Transactions</button>
        <button class="nav-tab" onclick="showTab('buckets', this)">ü™£ Buckets</button>
        <button class="nav-tab" onclick="showTab('debts', this)">üí≥ Debts</button>
        <button class="nav-tab" onclick="showTab('accounts', this)">üè¶ Accounts</button>
        <button class="nav-tab" onclick="showTab('reports', this)">üìà Reports</button>
        <button class="nav-tab" onclick="showTab('settings', this)">‚öôÔ∏è Settings</button>
    </div>

    <div class="container">
        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status">
            üéØ Demo Mode - Sample Financial Data
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid">
                <!-- Balance Overview -->
                <div class="card balance-card">
                    <div class="card-title">
                        <span>üè¶ Account Balance</span>
                    </div>
                    <div class="balance-amount" id="totalBalance">‚Ç¨1,924.50</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.9rem;">
                        <div style="text-align: center;">
                            <span style="font-weight: 600; display: block;">‚Ç¨1,000.00</span>
                            <div>Allocated</div>
                        </div>
                        <div style="text-align: center;">
                            <span style="font-weight: 600; display: block;">‚Ç¨924.50</span>
                            <div>Available</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-title">
                        <span>‚ö° Quick Actions</span>
                    </div>
                    <div class="input-group">
                        <label>Amount (‚Ç¨)</label>
                        <input type="number" id="quickAmount" placeholder="25.50" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Description</label>
                        <input type="text" id="quickDescription" placeholder="Coffee at Starbucks">
                    </div>
                    <div class="input-group">
                        <label>Category</label>
                        <select id="quickCategory">
                            <option value="Food">üçï Food</option>
                            <option value="Transport">üöó Transport</option>
                            <option value="Bills">üìÑ Bills</option>
                            <option value="Entertainment">üé¨ Entertainment</option>
                            <option value="Shopping">üõçÔ∏è Shopping</option>
                            <option value="Healthcare">üè• Healthcare</option>
                            <option value="Other">üì¶ Other</option>
                        </select>
                    </div>
                    <button class="btn" onclick="addExpense()">Add Expense</button>
                    <button class="btn btn-secondary" onclick="addIncome()" style="margin-top: 10px;">Add Income</button>
                </div>

                <!-- Monthly Spending -->
                <div class="card">
                    <div class="card-title">
                        <span>üìä Monthly Spending</span>
                        <button class="btn btn-small" onclick="refreshSpending()">‚Üª</button>
                    </div>
                    <div id="spendingContainer">
                        <div class="list-item">
                            <div><span style="margin-right: 8px;">üö®</span><strong>Entertainment</strong></div>
                            <div class="list-amount">‚Ç¨80.00 / ‚Ç¨80.00<br><small>(100%)</small></div>
                        </div>
                        <div class="list-item">
                            <div><span style="margin-right: 8px;">‚úÖ</span><strong>Food</strong></div>
                            <div class="list-amount">‚Ç¨125.50 / ‚Ç¨250.00<br><small>(50.2%)</small></div>
                        </div>
                        <div class="list-item">
                            <div><span style="margin-right: 8px;">‚úÖ</span><strong>Transport</strong></div>
                            <div class="list-amount">‚Ç¨45.00 / ‚Ç¨120.00<br><small>(37.5%)</small></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <div class="card">
                    <div class="card-title">
                        <span>üîî Active Alerts</span>
                    </div>
                    <div style="padding: 15px; background: rgba(245, 87, 108, 0.1); border-left: 4px solid #f5576c; border-radius: 0 8px 8px 0;">
                        <div style="font-weight: 600; margin-bottom: 5px; color: #d63384;">üö® Budget Alert: Entertainment</div>
                        <div style="font-size: 0.9rem; color: #666;">You've spent ‚Ç¨80.00/‚Ç¨80.00 (100%) of your Entertainment budget this month.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="grid">
                <!-- AI Expense Entry -->
                <div class="card">
                    <div class="card-title">
                        <span>ü§ñ AI-Powered Expense Entry</span>
                    </div>
                    <div class="input-group">
                        <label>Natural Language Input</label>
                        <textarea id="aiExpenseInput" placeholder="Try: 'I spent 23.50 on coffee at Starbucks this morning'" rows="2"></textarea>
                    </div>
                    <button class="btn" onclick="processAIExpense()">ü§ñ Parse with AI</button>
                </div>

                <!-- AI Assistant -->
                <div class="card">
                    <div class="card-title">
                        <span>üí° AI Financial Assistant</span>
                    </div>
                    <div class="input-group">
                        <label>Ask your AI assistant</label>
                        <textarea id="aiQuestion" placeholder="How much can I spend on entertainment this month?" rows="2"></textarea>
                    </div>
                    <button class="btn" onclick="askAIAssistant()">ü§ñ Ask AI</button>
                    <div id="aiResponse" style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; display: none;">
                        <div style="font-weight: 600; margin-bottom: 10px;">ü§ñ AI Response:</div>
                        <div id="aiResponseText"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buckets Tab -->
        <div id="buckets" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-title">
                        <span>ü™£ Bucket Overview</span>
                    </div>
                    <div class="list-item">
                        <div>
                            <h4>üî¥ Emergency Fund</h4>
                            <div class="progress-bar"><div class="progress-fill" style="width: 20%"></div></div>
                        </div>
                        <div class="list-amount">‚Ç¨500.00 / ‚Ç¨2,500.00<br><small>(20%)</small></div>
                    </div>
                    <div class="list-item">
                        <div>
                            <h4>üî¥ Flexible Buffer</h4>
                            <div class="progress-bar"><div class="progress-fill" style="width: 37.5%"></div></div>
                        </div>
                        <div class="list-amount">‚Ç¨150.00 / ‚Ç¨400.00<br><small>(37.5%)</small></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span>üí∞ Allocate to Bucket</span>
                    </div>
                    <div class="input-group">
                        <label>Bucket</label>
                        <select id="bucketSelect">
                            <option value="Emergency Fund">üö® Emergency Fund</option>
                            <option value="Flexible Buffer">üéØ Flexible Buffer</option>
                            <option value="Yearly Payments">üìÖ Yearly Payments</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Amount (‚Ç¨)</label>
                        <input type="number" id="bucketAmount" placeholder="100.00" step="0.01">
                    </div>
                    <button class="btn" onclick="allocateToBucket()">Allocate Money</button>
                </div>
            </div>
        </div>

        <!-- Debts Tab -->
        <div id="debts" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-title">
                        <span>üí≥ Debt Management</span>
                    </div>
                    <div class="list-item" style="background: rgba(220, 53, 69, 0.1);">
                        <div>
                            <strong>üí≥ Credit Card</strong>
                            <br><small>Due: 25th ‚Ä¢ Min: ‚Ç¨150</small>
                        </div>
                        <div style="color: #dc3545; text-align: right; font-weight: 600;">
                            ‚Ç¨1,850
                            <br><small>(~12.3 months)</small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span>‚ûï Add New Debt</span>
                    </div>
                    <div class="input-group">
                        <label>Debt Name</label>
                        <input type="text" placeholder="Car Loan, etc.">
                    </div>
                    <div class="input-group">
                        <label>Current Balance (‚Ç¨)</label>
                        <input type="number" placeholder="2500.00" step="0.01">
                    </div>
                    <button class="btn" onclick="addNewDebt()">‚ûï Add Debt</button>
                </div>
            </div>
        </div>

        <!-- Accounts Tab -->
        <div id="accounts" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-title">
                        <span>üè¶ All Accounts</span>
                    </div>
                    <div class="list-item">
                        <div><h4>üè¶ Main Account</h4><small>Checking</small></div>
                        <div class="list-amount">‚Ç¨1,924.50</div>
                    </div>
                    <div class="list-item">
                        <div><h4>üí∞ Savings</h4><small>Savings</small></div>
                        <div class="list-amount">‚Ç¨5,000.00</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span>‚ûï Add New Account</span>
                    </div>
                    <div class="input-group">
                        <label>Account Name</label>
                        <input type="text" placeholder="Investment Account">
                    </div>
                    <div class="input-group">
                        <label>Account Type</label>
                        <select>
                            <option value="checking">Checking</option>
                            <option value="savings">Savings</option>
                            <option value="investment">Investment</option>
                        </select>
                    </div>
                    <button class="btn" onclick="addNewAccount()">‚ûï Add Account</button>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-title">
                        <span>üìä AI Budget Insights</span>
                        <button class="btn btn-small" onclick="getAIInsights()">ü§ñ Analyze</button>
                    </div>
                    <div id="aiInsights">
                        <div class="loading">Click "Analyze" to get AI-powered budget insights</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span>üìà Monthly Report</span>
                    </div>
                    <div class="input-group">
                        <label>Select Month</label>
                        <select>
                            <option value="current">Current Month</option>
                            <option value="previous">Previous Month</option>
                        </select>
                    </div>
                    <button class="btn" onclick="generateReport()">Generate Report</button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <!-- AI Configuration -->
            <div class="settings-section">
                <h3>ü§ñ AI Configuration</h3>
                <div class="input-group">
                    <label>OpenAI API Key</label>
                    <input type="password" id="openaiApiKey" placeholder="sk-proj-...">
                    <small style="color: #666; font-size: 0.9rem;">Get your key from: <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></small>
                </div>
                <button class="btn" onclick="saveOpenAIKey()">üíæ Save API Key</button>
                <button class="btn btn-secondary" onclick="testAI()" style="margin-top: 10px;">üß™ Test AI</button>
            </div>

            <!-- Budget Settings -->
            <div class="settings-section">
                <h3>üìä Budget Settings</h3>
                <div class="input-group">
                    <label>Food Budget</label>
                    <input type="number" value="250" step="0.01">
                </div>
                <div class="input-group">
                    <label>Entertainment Budget</label>
                    <input type="number" value="80" step="0.01">
                </div>
                <button class="btn" onclick="saveBudgetSettings()">üíæ Save Budgets</button>
            </div>

            <!-- PWA Status -->
            <div class="settings-section">
                <h3>üì± PWA Status</h3>
                <div style="padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px; margin-bottom: 15px;">
                    <div><strong>Installation Status:</strong> <span id="installStatus">Running in browser</span></div>
                    <div><strong>Last Updated:</strong> <span id="lastUpdated">${new Date().toLocaleString()}</span></div>
                </div>
                <button class="btn btn-secondary" onclick="checkForUpdates()">üîÑ Check Updates</button>
            </div>
        </div>

        <!-- Message Container -->
        <div id="messageContainer"></div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://fbbsfxcftgoetfvnjevt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiYnNmeGNmdGdvZXRmdm5qZXZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NTM3MzksImV4cCI6MjA3MzQyOTczOX0.SgVG5AAJTcMC8wRJBvIjAibGc6oO126Wj6nK-XALvxY';
        
        let useDemo = false; // Try real connection first
        let isConnected = false;

        // Test Supabase connection
        async function testConnection() {
            try {
                console.log('Testing Supabase connection...');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/accounts?select=name,balance&limit=1`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    console.log('‚úÖ Supabase connection successful');
                    isConnected = true;
                    useDemo = false;
                    updateConnectionStatus(true);
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.log('‚ùå Supabase connection failed:', error);
                isConnected = false;
                useDemo = true;
                updateConnectionStatus(false);
                return false;
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            
            if (connected) {
                statusEl.className = 'connection-status';
                statusEl.style.background = 'rgba(25, 135, 84, 0.2)';
                statusEl.style.color = '#198754';
                statusEl.style.border = '2px solid #198754';
                statusEl.innerHTML = '‚úÖ Connected to Supabase - Real Data Active';
            } else {
                statusEl.className = 'connection-status';
                statusEl.style.background = 'rgba(220, 53, 69, 0.2)';
                statusEl.style.color = '#dc3545';
                statusEl.style.border = '2px solid #dc3545';
                statusEl.innerHTML = 'üîí Demo Mode - Supabase Connection Failed (CORS blocked)';
            }
        }

        // API Functions
        async function queryTable(tableName, params = '') {
            if (useDemo) {
                return getDemoData(tableName);
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${tableName}${params}`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Error querying ${tableName}:`, error);
                // Fall back to demo data if query fails
                return getDemoData(tableName);
            }
        }

        async function callFunction(functionName, params = {}) {
            if (useDemo) {
                console.log(`Demo mode: ${functionName} called with:`, params);
                return { success: true, message: 'Demo mode operation' };
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${functionName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(params),
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error(`Error calling ${functionName}:`, error);
                showMessage(`Database operation failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Load real data functions
        async function loadRealBalance() {
            try {
                const data = await queryTable('accounts', '?select=balance');
                if (data && data.length > 0) {
                    const totalBalance = data.reduce((sum, account) => sum + (account.balance || 0), 0);
                    document.getElementById('totalBalance').textContent = formatEuro(totalBalance);
                    showMessage('Real balance data loaded', 'success');
                }
            } catch (error) {
                console.error('Failed to load real balance:', error);
            }
        }

        async function loadRealSpending() {
            try {
                const data = await queryTable('monthly_spending_formatted');
                const container = document.getElementById('spendingContainer');
                
                if (data && data.length > 0) {
                    container.innerHTML = data.map(category => `
                        <div class="list-item">
                            <div><span style="margin-right: 8px;">${category.status_icon}</span><strong>${category.category}</strong></div>
                            <div class="list-amount">${category.spent} / ${category.budget_limit}<br><small>(${category.percent_used}%)</small></div>
                        </div>
                    `).join('');
                    showMessage('Real spending data loaded', 'success');
                } else {
                    container.innerHTML = '<div class="loading">No spending data found</div>';
                }
            } catch (error) {
                console.error('Failed to load real spending:', error);
            }
        }

        function formatEuro(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        // Tab Management
        function showTab(tabName, clickedElement) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Tab activated:', tabName);
            } else {
                console.error('Tab not found:', tabName);
            }

            // Add active class to clicked tab
            if (clickedElement) {
                clickedElement.classList.add('active');
            }

            showMessage(`Switched to ${tabName} tab`, 'info');
        }

        // Demo Functions (enhanced to try real data first)
        async function addExpense() {
            const amount = document.getElementById('quickAmount').value;
            const description = document.getElementById('quickDescription').value;
            const category = document.getElementById('quickCategory').value;
            
            if (!amount || !description) {
                showMessage('Please fill in amount and description', 'error');
                return;
            }

            if (useDemo) {
                showMessage(`Demo: Added ‚Ç¨${amount} expense for ${description} (${category})`, 'info');
                document.getElementById('quickAmount').value = '';
                document.getElementById('quickDescription').value = '';
                return;
            }

            try {
                const result = await callFunction('add_expense', {
                    account_name: 'Main Account',
                    category_name: category,
                    amount: parseFloat(amount),
                    description: description
                });

                if (result.success) {
                    showMessage(`‚úÖ Added ‚Ç¨${amount} expense for ${description}`, 'success');
                    document.getElementById('quickAmount').value = '';
                    document.getElementById('quickDescription').value = '';
                    await loadRealBalance();
                    await loadRealSpending();
                } else {
                    showMessage(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to add expense', 'error');
            }
        }

        async function addIncome() {
            const amount = document.getElementById('quickAmount').value;
            const description = document.getElementById('quickDescription').value;
            
            if (!amount || !description) {
                showMessage('Please fill in amount and description', 'error');
                return;
            }

            if (useDemo) {
                showMessage(`Demo: Added ‚Ç¨${amount} income for ${description}`, 'info');
                document.getElementById('quickAmount').value = '';
                document.getElementById('quickDescription').value = '';
                return;
            }

            try {
                const result = await callFunction('add_income', {
                    account_name: 'Main Account',
                    amount: parseFloat(amount),
                    description: description
                });

                if (result.success) {
                    showMessage(`‚úÖ Added ‚Ç¨${amount} income for ${description}`, 'success');
                    document.getElementById('quickAmount').value = '';
                    document.getElementById('quickDescription').value = '';
                    await loadRealBalance();
                } else {
                    showMessage(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to add income', 'error');
            }
        }

        // Initialize App with real connection test
        document.addEventListener('DOMContentLoaded', async function() {
            setupPWA();
            
            // Test Supabase connection first
            showMessage('Testing database connection...', 'info');
            const connected = await testConnection();
            
            if (connected) {
                showMessage('Connected to Supabase! Loading real data...', 'success');
                await loadRealBalance();
                await loadRealSpending();
            } else {
                showMessage('Using demo mode - Enable CORS in Supabase for real data', 'info');
            }
            
            console.log('App initialized successfully');
        });
    </script>
</body>
</html>
