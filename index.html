<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ali's Personal Finance</title>
    <meta name="description" content="Personal Finance Dashboard">
    <meta name="theme-color" content="#667eea">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Personal Finance">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Personal Finance">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        /* Header */
        .header {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            color: #f7fafc;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
            color: #cbd5e0;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tab-content.active {
            display: block;
            opacity: 1;
        }

        /* Connection Status */
        .connection-status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 600;
            background: rgba(13, 110, 253, 0.2);
            color: #90cdf4;
            border: 2px solid #4299e1;
        }

        /* Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: #e2e8f0;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.2);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #f7fafc;
        }

        /* Balance Card */
        .balance-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Forms */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #f7fafc;
            font-size: 0.95rem;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: rgba(26, 32, 44, 0.8);
            color: #f7fafc;
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: #a0aec0;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(26, 32, 44, 0.95);
        }

        .input-group small {
            color: #a0aec0;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
        }

        .input-group small a {
            color: #90cdf4;
            text-decoration: none;
        }

        .input-group small a:hover {
            text-decoration: underline;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* List Items */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(74, 85, 104, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        .list-item:hover {
            background: rgba(74, 85, 104, 0.5);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .list-amount {
            font-weight: 600;
            color: #90cdf4;
            text-align: right;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(74, 85, 104, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            animation: slideIn 0.3s ease;
            font-weight: 500;
        }

        .success {
            background: rgba(72, 187, 120, 0.2);
            color: #9ae6b4;
            border-left: 4px solid #48bb78;
        }

        .error {
            background: rgba(245, 101, 101, 0.2);
            color: #fed7d7;
            border-left: 4px solid #f56565;
        }

        .info {
            background: rgba(66, 153, 225, 0.2);
            color: #bee3f8;
            border-left: 4px solid #4299e1;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #a0aec0;
            font-style: italic;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(74, 85, 104, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #90cdf4;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* AI Response */
        .ai-response {
            margin-top: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.15);
            border-radius: 8px;
            border-left: 4px solid #667eea;
            color: #e2e8f0;
        }

        .ai-response h4 {
            font-weight: 600;
            margin-bottom: 10px;
            color: #90cdf4;
        }

        /* Alert Cards */
        .alert-card {
            padding: 15px;
            background: rgba(245, 101, 101, 0.15);
            border-left: 4px solid #f56565;
            border-radius: 0 8px 8px 0;
            margin-bottom: 10px;
            color: #e2e8f0;
        }

        .alert-card.warning {
            background: rgba(237, 137, 54, 0.15);
            border-left-color: #ed8936;
        }

        .alert-card.info {
            background: rgba(66, 153, 225, 0.15);
            border-left-color: #4299e1;
        }

        .alert-card.success {
            background: rgba(72, 187, 120, 0.15);
            border-left-color: #48bb78;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #f7fafc;
        }

        .alert-message {
            font-size: 0.9rem;
            color: #cbd5e0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .nav-tab {
                flex-shrink: 0;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .balance-amount {
                font-size: 2rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .masked-key {
            font-family: monospace;
            background: rgba(74, 85, 104, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #a0aec0;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>💰 Personal Finance Dashboard</h1>
        <p>AI-Powered Financial Management</p>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('dashboard', this)">📊 Dashboard</button>
        <button class="nav-tab" onclick="showTab('transactions', this)">💳 Transactions</button>
        <button class="nav-tab" onclick="showTab('buckets', this)">🪣 Buckets</button>
        <button class="nav-tab" onclick="showTab('debts', this)">💳 Debts</button>
        <button class="nav-tab" onclick="showTab('accounts', this)">🏦 Accounts</button>
        <button class="nav-tab" onclick="showTab('reports', this)">📈 Reports</button>
        <button class="nav-tab" onclick="showTab('settings', this)">⚙️ Settings</button>
    </div>

    <div class="container">
        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status">
            🔄 Testing Database Connection...
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid">
                <!-- Balance Overview -->
                <div class="card balance-card">
                    <div class="card-title">
                        <span>🏦 Account Balance</span>
                    </div>
                    <div class="balance-amount" id="totalBalance">€0.00</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.9rem;">
                        <div style="text-align: center;">
                            <span style="font-weight: 600; display: block;" id="allocatedAmount">€0.00</span>
                            <div>Allocated</div>
                        </div>
                        <div style="text-align: center;">
                            <span style="font-weight: 600; display: block;" id="availableAmount">€0.00</span>
                            <div>Available</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-title">
                        <span>⚡ Quick Actions</span>
                    </div>
                    <div class="input-group">
                        <label>Amount (€)</label>
                        <input type="number" id="quickAmount" placeholder="25.50" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Description</label>
                        <input type="text" id="quickDescription" placeholder="Coffee at Starbucks">
                    </div>
                    <div class="input-group">
                        <label>Category</label>
                        <select id="quickCategory">
                            <option value="Food">🍕 Food</option>
                            <option value="Transport">🚗 Transport</option>
                            <option value="Bills">📄 Bills</option>
                            <option value="Entertainment">🎬 Entertainment</option>
                            <option value="Shopping">🛍️ Shopping</option>
                            <option value="Healthcare">🏥 Healthcare</option>
                            <option value="Other">📦 Other</option>
                        </select>
                    </div>
                    <button class="btn" onclick="addExpense()">Add Expense</button>
                    <button class="btn btn-secondary" onclick="addIncome()" style="margin-top: 10px;">Add Income</button>
                </div>

                <!-- Monthly Spending -->
                <div class="card">
                    <div class="card-title">
                        <span>📊 Monthly Spending</span>
                        <button class="btn btn-small" onclick="refreshSpending()">↻</button>
                    </div>
                    <div id="spendingContainer">
                        <div class="loading">Loading spending data...</div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <div class="card">
                    <div class="card-title">
                        <span>🔔 Active Alerts</span>
                    </div>
                    <div id="alertsContainer">
                        <div class="loading">Loading alerts...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="grid">
                <!-- AI Expense Entry -->
                <div class="card">
                    <div class="card-title">
                        <span>🤖 AI-Powered Expense Entry</span>
                    </div>
                    <div class="input-group">
                        <label>Natural Language Input</label>
                        <textarea id="aiExpenseInput" placeholder="Try: 'I spent 23.50 on coffee at Starbucks this morning'" rows="3"></textarea>
                    </div>
                    <button class="btn" onclick="processAIExpense()">🤖 Parse with AI</button>
                    <div id="aiExpenseResult" class="ai-response" style="display: none;">
                        <h4>🤖 AI Parsed Result:</h4>
                        <div id="aiExpenseResultText"></div>
                        <button class="btn btn-success" onclick="confirmAIExpense()" style="margin-top: 10px; display: none;" id="confirmAIBtn">✅ Confirm & Add</button>
                    </div>
                </div>

                <!-- AI Assistant -->
                <div class="card">
                    <div class="card-title">
                        <span>💡 AI Financial Assistant</span>
                    </div>
                    <div class="input-group">
                        <label>Ask your AI assistant</label>
                        <textarea id="aiQuestion" placeholder="How much can I spend on entertainment this month?" rows="2"></textarea>
                    </div>
                    <button class="btn" onclick="askAIAssistant()">🤖 Ask AI</button>
                    <div id="aiResponse" class="ai-response" style="display: none;">
                        <h4>🤖 AI Response:</h4>
                        <div id="aiResponseText"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buckets Tab -->
        <div id="buckets" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-title">
                        <span>🪣 Bucket Overview</span>
                    </div>
                    <div id="bucketsContainer">
                        <div class="loading">Loading buckets...</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span>💰 Allocate to Bucket</span>
                    </div>
                    <div class="input-group">
                        <label>Bucket</label>
                        <select id="bucketSelect">
                            <option value="">Loading buckets...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Amount (€)</label>
                        <input type="number" id="bucketAmount" placeholder="100.00" step="0.01">
                    </div>
                    <button class="btn" onclick="allocateToBucket()">Allocate Money</button>
                </div>
            </div>
        </div>

        <!-- Debts Tab -->
        <div id="debts" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-title">
                        <span>💳 Debt Management</span>
                    </div>
                    <div id="debtsContainer">
                        <div class="loading">Loading debts...</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span>➕ Add New Debt</span>
                    </div>
                    <div class="input-group">
                        <label>Debt Name</label>
                        <input type="text" id="debtName" placeholder="Car Loan, etc.">
                    </div>
                    <div class="input-group">
                        <label>Current Balance (€)</label>
                        <input type="number" id="debtBalance" placeholder="2500.00" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Minimum Payment (€)</label>
                        <input type="number" id="debtMinPayment" placeholder="150.00" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Due Day</label>
                        <input type="number" id="debtDueDay" placeholder="25" min="1" max="31">
                    </div>
                    <button class="btn" onclick="addNewDebt()">➕ Add Debt</button>
                </div>
            </div>
        </div>

        <!-- Accounts Tab -->
        <div id="accounts" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-title">
                        <span>🏦 All Accounts</span>
                    </div>
                    <div id="accountsContainer">
                        <div class="loading">Loading accounts...</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span>➕ Add New Account</span>
                    </div>
                    <div class="input-group">
                        <label>Account Name</label>
                        <input type="text" id="accountName" placeholder="Investment Account">
                    </div>
                    <div class="input-group">
                        <label>Account Type</label>
                        <select id="accountType">
                            <option value="checking">Checking</option>
                            <option value="savings">Savings</option>
                            <option value="investment">Investment</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Initial Balance (€)</label>
                        <input type="number" id="accountBalance" placeholder="1000.00" step="0.01">
                    </div>
                    <button class="btn" onclick="addNewAccount()">➕ Add Account</button>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-title">
                        <span>📊 AI Budget Insights</span>
                        <button class="btn btn-small" onclick="getAIInsights()">🤖 Analyze</button>
                    </div>
                    <div id="aiInsights">
                        <div class="loading">Click "Analyze" to get AI-powered budget insights</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span>📈 Monthly Report</span>
                    </div>
                    <div class="input-group">
                        <label>Select Month</label>
                        <select id="reportMonth">
                            <option value="current">Current Month</option>
                            <option value="previous">Previous Month</option>
                        </select>
                    </div>
                    <button class="btn" onclick="generateReport()">Generate Report</button>
                    <div id="reportContainer" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <!-- AI Configuration -->
            <div class="settings-section">
                <h3>🤖 AI Configuration</h3>
                <div class="input-group">
                    <label>OpenAI API Key</label>
                    <input type="password" id="openaiApiKey" placeholder="sk-proj-...">
                    <small>Get your key from: <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></small>
                </div>
                <div id="currentApiKey" class="masked-key" style="display: none;"></div>
                <button class="btn" onclick="saveOpenAIKey()">💾 Save API Key</button>
                <button class="btn btn-secondary" onclick="testAI()" style="margin-top: 10px;">🧪 Test AI Connection</button>
                <button class="btn btn-small" onclick="loadCurrentApiKey()" style="margin-top: 10px;">👁️ Show Current Key</button>
                <div id="aiTestResult" class="ai-response" style="display: none; margin-top: 15px;">
                    <h4>🧪 AI Test Result:</h4>
                    <div id="aiTestResultText"></div>
                </div>
            </div>

            <!-- Budget Settings -->
            <div class="settings-section">
                <h3>📊 Budget Settings</h3>
                <div class="input-group">
                    <label>Food Budget (€)</label>
                    <input type="number" id="foodBudget" value="250" step="0.01">
                </div>
                <div class="input-group">
                    <label>Entertainment Budget (€)</label>
                    <input type="number" id="entertainmentBudget" value="80" step="0.01">
                </div>
                <div class="input-group">
                    <label>Transport Budget (€)</label>
                    <input type="number" id="transportBudget" value="120" step="0.01">
                </div>
                <button class="btn" onclick="saveBudgetSettings()">💾 Save Budget Settings</button>
            </div>

            <!-- Database Status -->
            <div class="settings-section">
                <h3>🗄️ Database Status</h3>
                <div style="padding: 15px; background: rgba(74, 85, 104, 0.3); border-radius: 8px; margin-bottom: 15px;">
                    <div><strong>Connection Status:</strong> <span id="dbStatus">Unknown</span></div>
                    <div><strong>Last Check:</strong> <span id="lastCheck">Never</span></div>
                    <div><strong>API Key Status:</strong> <span id="apiKeyStatus">Unknown</span></div>
                </div>
                <button class="btn btn-secondary" onclick="testConnection()">🔄 Test Connection</button>
            </div>
        </div>

        <!-- Message Container -->
        <div id="messageContainer"></div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://fbbsfxcftgoetfvnjevt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZiYnNmeGNmdGdvZXRmdm5qZXZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NTM3MzksImV4cCI6MjA3MzQyOTczOX0.SgVG5AAJTcMC8wRJBvIjAibGc6oO126Wj6nK-XALvxY';
        
        let useDemo = false;
        let isConnected = false;
        let currentParsedExpense = null;

        // Common headers for all requests
        const getHeaders = () => ({
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Prefer': 'return=representation'
        });

        // Test Supabase connection
        async function testConnection() {
            try {
                console.log('🔄 Testing Supabase connection...');
                updateDbStatus('Testing...', new Date().toLocaleString());
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/accounts?select=name,balance&limit=1`, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    console.log('✅ Supabase connection successful');
                    isConnected = true;
                    useDemo = false;
                    updateConnectionStatus(true);
                    updateDbStatus('Connected ✅', new Date().toLocaleString());
                    return true;
                } else {
                    console.log('❌ HTTP Error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.log('❌ Supabase connection failed:', error.message);
                isConnected = false;
                useDemo = true;
                updateConnectionStatus(false, error.message);
                updateDbStatus('Failed ❌', new Date().toLocaleString());
                return false;
            }
        }

        function updateDbStatus(status, lastCheck) {
            if (document.getElementById('dbStatus')) {
                document.getElementById('dbStatus').textContent = status;
                document.getElementById('lastCheck').textContent = lastCheck;
            }
        }

        function updateConnectionStatus(connected, errorMessage = '') {
            const statusEl = document.getElementById('connectionStatus');
            
            if (connected) {
                statusEl.style.background = 'rgba(72, 187, 120, 0.2)';
                statusEl.style.color = '#9ae6b4';
                statusEl.style.border = '2px solid #48bb78';
                statusEl.innerHTML = '✅ Connected to Supabase - Real Data Active';
            } else {
                statusEl.style.background = 'rgba(245, 101, 101, 0.2)';
                statusEl.style.color = '#fed7d7';
                statusEl.style.border = '2px solid #f56565';
                statusEl.innerHTML = `🔒 Demo Mode - Connection Failed: ${errorMessage || 'Unknown error'}`;
            }
        }

        // API Functions
        async function queryTable(tableName, params = '') {
            if (useDemo) {
                return getDemoData(tableName);
            }

            try {
                const url = `${SUPABASE_URL}/rest/v1/${tableName}${params}`;
                console.log('📡 Querying:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Query failed:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('✅ Query successful:', data);
                return data;
            } catch (error) {
                console.error(`❌ Error querying ${tableName}:`, error);
                showMessage(`Database query failed: ${error.message}`, 'error');
                return getDemoData(tableName);
            }
        }

        async function callFunction(functionName, params = {}) {
            if (useDemo) {
                console.log(`🎭 Demo mode: ${functionName} called with:`, params);
                return { success: true, message: 'Demo mode operation' };
            }

            try {
                const url = `${SUPABASE_URL}/rest/v1/rpc/${functionName}`;
                console.log('📡 Calling function:', url, params);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(params)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Function call failed:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ Function call successful:', result);
                return result;
            } catch (error) {
                console.error(`❌ Error calling ${functionName}:`, error);
                showMessage(`Database operation failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Demo data fallback
        function getDemoData(tableName) {
            const demoData = {
                'accounts': [
                    { name: 'Main Account', balance: '1924.50', type: 'checking' }
                ],
                'monthly_spending_formatted': [
                    { category: 'Entertainment', spent_formatted: '€80.00', budget_formatted: '€80.00', percent_used: '100.0', status_icon: '🚨' },
                    { category: 'Food', spent_formatted: '€125.50', budget_formatted: '€250.00', percent_used: '50.2', status_icon: '✅' },
                    { category: 'Transport', spent_formatted: '€45.00', budget_formatted: '€120.00', percent_used: '37.5', status_icon: '✅' }
                ],
                'buckets': [
                    { name: 'Emergency Fund', allocated_amount: '500.00', target_amount: '2500.00' },
                    { name: 'Flexible Buffer', allocated_amount: '150.00', target_amount: '400.00' }
                ],
                'debts': [
                    { name: 'Credit Card', remaining: '1850.00', minimum_payment: '150.00', due_day: 25 }
                ]
            };
            
            return demoData[tableName] || [];
        }

        // Load data functions
        async function loadRealBalance() {
            try {
                console.log('📊 Loading balance data...');
                const data = await queryTable('accounts', '?select=balance');
                
                if (data && data.length > 0) {
                    const totalBalance = data.reduce((sum, account) => sum + parseFloat(account.balance || 0), 0);
                    document.getElementById('totalBalance').textContent = formatEuro(totalBalance);
                    
                    const bucketsData = await queryTable('buckets', '?select=allocated_amount');
                    let totalAllocated = 0;
                    if (bucketsData && bucketsData.length > 0) {
                        totalAllocated = bucketsData.reduce((sum, bucket) => sum + parseFloat(bucket.allocated_amount || 0), 0);
                    }
                    
                    document.getElementById('allocatedAmount').textContent = formatEuro(totalAllocated);
                    document.getElementById('availableAmount').textContent = formatEuro(totalBalance - totalAllocated);
                    
                    showMessage('✅ Balance data loaded successfully', 'success');
                } else {
                    document.getElementById('totalBalance').textContent = '€0.00';
                    showMessage('⚠️ No account data found', 'info');
                }
            } catch (error) {
                console.error('❌ Failed to load balance:', error);
                showMessage('❌ Failed to load balance data', 'error');
            }
        }

        async function loadRealSpending() {
            try {
                console.log('📊 Loading spending data...');
                const data = await queryTable('monthly_spending_formatted');
                const container = document.getElementById('spendingContainer');
                
                if (data && data.length > 0) {
                    container.innerHTML = data.map(category => `
                        <div class="list-item">
                            <div><span style="margin-right: 8px;">${category.status_icon}</span><strong>${category.category}</strong></div>
                            <div class="list-amount">${category.spent_formatted} / ${category.budget_formatted}<br><small>(${category.percent_used}%)</small></div>
                        </div>
                    `).join('');
                    showMessage('✅ Spending data loaded successfully', 'success');
                } else {
                    container.innerHTML = '<div class="loading">No spending data found</div>';
                }
            } catch (error) {
                console.error('❌ Failed to load spending:', error);
                showMessage('❌ Failed to load spending data', 'error');
            }
        }

        async function loadBuckets() {
            try {
                console.log('🪣 Loading buckets data...');
                const data = await queryTable('buckets', '?select=name,allocated_amount,target_amount&is_active=eq.true');
                const container = document.getElementById('bucketsContainer');
                const select = document.getElementById('bucketSelect');
                
                if (data && data.length > 0) {
                    container.innerHTML = data.map(bucket => {
                        const percentage = bucket.target_amount > 0 ? (parseFloat(bucket.allocated_amount) / parseFloat(bucket.target_amount)) * 100 : 0;
                        const statusIcon = percentage >= 100 ? '✅' : percentage >= 80 ? '⚠️' : '🔴';
                        
                        return `
                            <div class="list-item">
                                <div>
                                    <h4>${statusIcon} ${bucket.name}</h4>
                                    <div class="progress-bar"><div class="progress-fill" style="width: ${Math.min(percentage, 100)}%"></div></div>
                                </div>
                                <div class="list-amount">${formatEuro(bucket.allocated_amount)} / ${formatEuro(bucket.target_amount)}<br><small>(${percentage.toFixed(1)}%)</small></div>
                            </div>
                        `;
                    }).join('');
                    
                    select.innerHTML = data.map(bucket => `<option value="${bucket.name}">${bucket.name}</option>`).join('');
                    showMessage('✅ Buckets data loaded successfully', 'success');
                } else {
                    container.innerHTML = '<div class="loading">No buckets found</div>';
                    select.innerHTML = '<option value="">No buckets available</option>';
                }
            } catch (error) {
                console.error('❌ Failed to load buckets:', error);
                showMessage('❌ Failed to load buckets data', 'error');
            }
        }

        async function loadDebts() {
            try {
                console.log('💳 Loading debts data...');
                const data = await queryTable('debts', '?select=name,remaining,minimum_payment,due_day&is_active=eq.true');
                const container = document.getElementById('debtsContainer');
                
                if (data && data.length > 0) {
                    container.innerHTML = data.map(debt => {
                        const monthsToPayOff = debt.minimum_payment > 0 ? (parseFloat(debt.remaining) / parseFloat(debt.minimum_payment)).toFixed(1) : '∞';
                        
                        return `
                            <div class="list-item alert-card">
                                <div>
                                    <strong>💳 ${debt.name}</strong>
                                    <br><small>Due: ${debt.due_day}th • Min: ${formatEuro(debt.minimum_payment)}</small>
                                </div>
                                <div style="text-align: right; font-weight: 600;">
                                    ${formatEuro(debt.remaining)}
                                    <br><small>(~${monthsToPayOff} months)</small>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    showMessage('✅ Debts data loaded successfully', 'success');
                } else {
                    container.innerHTML = '<div class="loading">No debts found</div>';
                }
            } catch (error) {
                console.error('❌ Failed to load debts:', error);
                showMessage('❌ Failed to load debts data', 'error');
            }
        }

        async function loadAccounts() {
            try {
                console.log('🏦 Loading accounts data...');
                const data = await queryTable('accounts', '?select=name,type,balance');
                const container = document.getElementById('accountsContainer');
                
                if (data && data.length > 0) {
                    container.innerHTML = data.map(account => `
                        <div class="list-item">
                            <div><h4>🏦 ${account.name}</h4><small>${account.type}</small></div>
                            <div class="list-amount">${formatEuro(account.balance)}</div>
                        </div>
                    `).join('');
                    
                    showMessage('✅ Accounts data loaded successfully', 'success');
                } else {
                    container.innerHTML = '<div class="loading">No accounts found</div>';
                }
            } catch (error) {
                console.error('❌ Failed to load accounts:', error);
                showMessage('❌ Failed to load accounts data', 'error');
            }
        }

        async function loadAlerts() {
            try {
                console.log('🔔 Loading alerts data...');
                const data = await queryTable('alerts', '?select=title,message,alert_type,priority&status=eq.pending&limit=5');
                const container = document.getElementById('alertsContainer');
                
                if (data && data.length > 0) {
                    container.innerHTML = data.map(alert => {
                        const iconMap = {
                            'budget_warning': '🚨',
                            'payment_due': '💳',
                            'debt_reminder': '💰',
                            'goal_achieved': '🎉',
                            'task_reminder': '📋'
                        };
                        
                        const priorityClasses = {
                            'urgent': 'alert-card',
                            'high': 'alert-card warning',
                            'medium': 'alert-card info',
                            'low': 'alert-card success'
                        };
                        
                        return `
                            <div class="${priorityClasses[alert.priority] || 'alert-card info'}">
                                <div class="alert-title">${iconMap[alert.alert_type] || '🔔'} ${alert.title}</div>
                                <div class="alert-message">${alert.message}</div>
                            </div>
                        `;
                    }).join('');
                    
                    showMessage('✅ Alerts data loaded successfully', 'success');
                } else {
                    container.innerHTML = '<div class="loading">No active alerts</div>';
                }
            } catch (error) {
                console.error('❌ Failed to load alerts:', error);
                showMessage('❌ Failed to load alerts data', 'error');
            }
        }

        function formatEuro(amount) {
            const num = typeof amount === 'string' ? parseFloat(amount) : amount;
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(num || 0);
        }

        // Tab Management
        function showTab(tabName, clickedElement) {
            console.log('🔄 Switching to tab:', tabName);
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            if (clickedElement) {
                clickedElement.classList.add('active');
            }

            // Load data for specific tabs
            if (tabName === 'buckets') {
                loadBuckets();
            } else if (tabName === 'debts') {
                loadDebts();
            } else if (tabName === 'accounts') {
                loadAccounts();
            } else if (tabName === 'settings') {
                loadCurrentApiKey();
            }

            showMessage(`Switched to ${tabName} tab`, 'info');
        }

        // Action Functions
        async function addExpense() {
            const amount = document.getElementById('quickAmount').value;
            const description = document.getElementById('quickDescription').value;
            const category = document.getElementById('quickCategory').value;
            
            if (!amount || !description) {
                showMessage('Please fill in amount and description', 'error');
                return;
            }

            if (useDemo) {
                showMessage(`Demo: Added €${amount} expense for ${description} (${category})`, 'info');
                clearQuickForm();
                return;
            }

            try {
                const result = await callFunction('add_expense', {
                    account_name: 'Main Account',
                    category_name: category,
                    amount: parseFloat(amount),
                    description: description
                });

                if (result.success !== false) {
                    showMessage(`✅ Added €${amount} expense for ${description}`, 'success');
                    clearQuickForm();
                    await loadRealBalance();
                    await loadRealSpending();
                    await loadAlerts();
                } else {
                    showMessage(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to add expense', 'error');
            }
        }

        async function addIncome() {
            const amount = document.getElementById('quickAmount').value;
            const description = document.getElementById('quickDescription').value;
            
            if (!amount || !description) {
                showMessage('Please fill in amount and description', 'error');
                return;
            }

            if (useDemo) {
                showMessage(`Demo: Added €${amount} income for ${description}`, 'info');
                clearQuickForm();
                return;
            }

            try {
                const result = await callFunction('add_income', {
                    account_name: 'Main Account',
                    amount: parseFloat(amount),
                    description: description
                });

                if (result.success !== false) {
                    showMessage(`✅ Added €${amount} income for ${description}`, 'success');
                    clearQuickForm();
                    await loadRealBalance();
                } else {
                    showMessage(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to add income', 'error');
            }
        }

        async function allocateToBucket() {
            const bucketName = document.getElementById('bucketSelect').value;
            const amount = document.getElementById('bucketAmount').value;
            
            if (!bucketName || !amount) {
                showMessage('Please select bucket and enter amount', 'error');
                return;
            }

            if (useDemo) {
                showMessage(`Demo: Allocated €${amount} to ${bucketName}`, 'info');
                document.getElementById('bucketAmount').value = '';
                return;
            }

            try {
                const result = await callFunction('allocate_to_bucket', {
                    bucket_name: bucketName,
                    amount: parseFloat(amount)
                });

                if (result.success !== false) {
                    showMessage(`✅ Allocated €${amount} to ${bucketName}`, 'success');
                    document.getElementById('bucketAmount').value = '';
                    await loadBuckets();
                    await loadRealBalance();
                } else {
                    showMessage(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to allocate to bucket', 'error');
            }
        }

        // AI Functions
        async function processAIExpense() {
            const expenseText = document.getElementById('aiExpenseInput').value;
            
            if (!expenseText.trim()) {
                showMessage('Please enter expense description', 'error');
                return;
            }

            try {
                const result = await callFunction('parse_expense_with_ai', {
                    expense_text: expenseText
                });

                if (result && result.success) {
                    const parsed = result.parsed;
                    currentParsedExpense = parsed;
                    
                    document.getElementById('aiExpenseResultText').innerHTML = `
                        <strong>Amount:</strong> €${parsed.amount}<br>
                        <strong>Category:</strong> ${parsed.category}<br>
                        <strong>Description:</strong> ${parsed.description}<br>
                        <strong>Confidence:</strong> ${(parsed.confidence * 100).toFixed(1)}%
                    `;
                    
                    document.getElementById('aiExpenseResult').style.display = 'block';
                    document.getElementById('confirmAIBtn').style.display = 'block';
                    
                    showMessage('✅ AI parsing completed', 'success');
                } else {
                    showMessage(`AI parsing failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to parse expense with AI', 'error');
            }
        }

        async function confirmAIExpense() {
            if (!currentParsedExpense) {
                showMessage('No parsed expense to confirm', 'error');
                return;
            }

            try {
                const result = await callFunction('add_expense', {
                    account_name: 'Main Account',
                    category_name: currentParsedExpense.category,
                    amount: parseFloat(currentParsedExpense.amount),
                    description: currentParsedExpense.description
                });

                if (result.success !== false) {
                    showMessage(`✅ Added AI-parsed expense: €${currentParsedExpense.amount} for ${currentParsedExpense.description}`, 'success');
                    document.getElementById('aiExpenseInput').value = '';
                    document.getElementById('aiExpenseResult').style.display = 'none';
                    currentParsedExpense = null;
                    await loadRealBalance();
                    await loadRealSpending();
                    await loadAlerts();
                } else {
                    showMessage(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to add AI-parsed expense', 'error');
            }
        }

        async function askAIAssistant() {
            const question = document.getElementById('aiQuestion').value;
            
            if (!question.trim()) {
                showMessage('Please enter a question', 'error');
                return;
            }

            try {
                const result = await callFunction('get_ai_financial_advice', {
                    question: question
                });

                if (result && result.success) {
                    document.getElementById('aiResponseText').textContent = result.advice;
                    document.getElementById('aiResponse').style.display = 'block';
                    showMessage('✅ AI advice generated', 'success');
                } else {
                    showMessage(`AI advice failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to get AI advice', 'error');
            }
        }

        // API Key Management
        async function saveOpenAIKey() {
            const apiKey = document.getElementById('openaiApiKey').value;
            
            if (!apiKey.trim()) {
                showMessage('Please enter an API key', 'error');
                return;
            }

            if (!apiKey.startsWith('sk-')) {
                showMessage('Invalid API key format. Should start with "sk-"', 'error');
                return;
            }

            try {
                const result = await callFunction('update_api_key', {
                    service: 'openai',
                    new_key: apiKey
                });

                if (result && result.success) {
                    showMessage('✅ OpenAI API key saved successfully', 'success');
                    document.getElementById('openaiApiKey').value = '';
                    await loadCurrentApiKey();
                    updateApiKeyStatus('Stored ✅');
                } else {
                    showMessage(`Failed to save API key: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to save API key', 'error');
            }
        }

        async function loadCurrentApiKey() {
            try {
                const result = await callFunction('get_masked_api_key', {
                    service: 'openai'
                });

                if (result && result.success) {
                    document.getElementById('currentApiKey').textContent = `Current key: ${result.masked_key}`;
                    document.getElementById('currentApiKey').style.display = 'block';
                    updateApiKeyStatus('Loaded ✅');
                } else {
                    document.getElementById('currentApiKey').textContent = 'No API key found';
                    document.getElementById('currentApiKey').style.display = 'block';
                    updateApiKeyStatus('Not found ❌');
                }
            } catch (error) {
                console.error('Failed to load API key:', error);
                updateApiKeyStatus('Error ❌');
            }
        }

        async function testAI() {
            try {
                const result = await callFunction('test_openai_connection');

                if (result && result.success) {
                    document.getElementById('aiTestResultText').innerHTML = `
                        <strong>Status:</strong> ${result.message}<br>
                        <strong>Key Preview:</strong> ${result.key_preview || 'Hidden'}
                    `;
                    document.getElementById('aiTestResult').style.display = 'block';
                    showMessage('✅ AI connection test completed', 'success');
                    updateApiKeyStatus('Working ✅');
                } else {
                    document.getElementById('aiTestResultText').textContent = `Test failed: ${result.error}`;
                    document.getElementById('aiTestResult').style.display = 'block';
                    showMessage(`AI test failed: ${result.error}`, 'error');
                    updateApiKeyStatus('Failed ❌');
                }
            } catch (error) {
                showMessage('Failed to test AI connection', 'error');
                updateApiKeyStatus('Error ❌');
            }
        }

        function updateApiKeyStatus(status) {
            if (document.getElementById('apiKeyStatus')) {
                document.getElementById('apiKeyStatus').textContent = status;
            }
        }

        // Other Functions
        function clearQuickForm() {
            document.getElementById('quickAmount').value = '';
            document.getElementById('quickDescription').value = '';
        }

        async function refreshSpending() {
            showMessage('🔄 Refreshing spending data...', 'info');
            await loadRealSpending();
        }

        async function addNewDebt() {
            const name = document.getElementById('debtName').value;
            const balance = document.getElementById('debtBalance').value;
            const minPayment = document.getElementById('debtMinPayment').value;
            const dueDay = document.getElementById('debtDueDay').value;
            
            if (!name || !balance || !minPayment || !dueDay) {
                showMessage('Please fill in all debt fields', 'error');
                return;
            }

            // This would need a proper debt creation function in Supabase
            showMessage('💳 Add debt feature - would insert into debts table', 'info');
        }

        async function addNewAccount() {
            const name = document.getElementById('accountName').value;
            const type = document.getElementById('accountType').value;
            const balance = document.getElementById('accountBalance').value;
            
            if (!name || !balance) {
                showMessage('Please fill in account name and balance', 'error');
                return;
            }

            // This would need a proper account creation function in Supabase
            showMessage('🏦 Add account feature - would insert into accounts table', 'info');
        }

        async function getAIInsights() {
            try {
                const result = await callFunction('get_ai_financial_advice', {
                    question: 'Provide comprehensive budget insights and recommendations'
                });

                if (result && result.success) {
                    document.getElementById('aiInsights').innerHTML = `
                        <div class="ai-response">
                            <h4>📊 AI Budget Analysis:</h4>
                            <p>${result.advice}</p>
                        </div>
                    `;
                    showMessage('✅ AI insights generated', 'success');
                } else {
                    showMessage(`AI insights failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('Failed to get AI insights', 'error');
            }
        }

        function generateReport() {
            showMessage('📈 Report generation feature - would create detailed financial report', 'info');
        }

        async function saveBudgetSettings() {
            const food = document.getElementById('foodBudget').value;
            const entertainment = document.getElementById('entertainmentBudget').value;
            const transport = document.getElementById('transportBudget').value;
            
            // This would update the categories table with new budget limits
            showMessage('💾 Budget settings - would update category budget limits', 'info');
        }

        // Message system
        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            
            container.appendChild(message);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (container.contains(message)) {
                    container.removeChild(message);
                }
            }, 5000);
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing Personal Finance App...');
            
            // Test Supabase connection first
            showMessage('🔄 Testing database connection...', 'info');
            const connected = await testConnection();
            
            if (connected) {
                showMessage('✅ Connected to Supabase! Loading data...', 'success');
                
                // Load all initial data
                await Promise.all([
                    loadRealBalance(),
                    loadRealSpending(),
                    loadAlerts()
                ]);
                
                console.log('✅ App initialized with real data');
            } else {
                showMessage('⚠️ Using demo mode - real database connection failed', 'info');
                
                // Load demo data
                const demoBalance = getDemoData('accounts');
                if (demoBalance.length > 0) {
                    document.getElementById('totalBalance').textContent = formatEuro(demoBalance[0].balance);
                }
                
                const demoSpending = getDemoData('monthly_spending_formatted');
                const spendingContainer = document.getElementById('spendingContainer');
                spendingContainer.innerHTML = demoSpending.map(category => `
                    <div class="list-item">
                        <div><span style="margin-right: 8px;">${category.status_icon}</span><strong>${category.category}</strong></div>
                        <div class="list-amount">${category.spent_formatted} / ${category.budget_formatted}<br><small>(${category.percent_used}%)</small></div>
                    </div>
                `).join('');
                
                // Demo alerts
                document.getElementById('alertsContainer').innerHTML = `
                    <div class="alert-card">
                        <div class="alert-title">🚨 Budget Alert: Entertainment</div>
                        <div class="alert-message">You've spent €80.00/€80.00 (100%) of your Entertainment budget this month.</div>
                    </div>
                `;
                
                console.log('✅ App initialized with demo data');
            }
            
            console.log('🎉 Personal Finance App ready!');
        });
    </script>
</body>
</html>
